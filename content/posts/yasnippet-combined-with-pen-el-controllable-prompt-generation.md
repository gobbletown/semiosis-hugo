+++
title = "YASnippet combined with Pen.el - Controllable prompt generation"
author = ["Shane Mulligan"]
date = 2021-08-09T00:00:00+12:00
keywords = ["gpt", "emacs", "yas", "pen", "gpt-j"]
draft = false
+++

## Summary {#summary}

I include YASnippet in the prompt generation
pipeline to enable programmatic manipulation
within a prompt using `emacs` functions and
keyboard macros.

In essence, this gives you the ability to make
language agnostic prompts.

This is using `GPT-J` by EleutherAI, via the `AIx` API.


## Demo {#demo}

<!-- Play on asciinema.com -->
<!-- <a title="asciinema recording" href="https://asciinema.org/a/r3I69k0ItYpqyaMfsIku0rsiA" target="_blank"><img alt="asciinema recording" src="https://asciinema.org/a/r3I69k0ItYpqyaMfsIku0rsiA.svg" /></a> -->
<!-- Play on the blog -->
<script src="https://asciinema.org/a/r3I69k0ItYpqyaMfsIku0rsiA.js" id="asciicast-r3I69k0ItYpqyaMfsIku0rsiA" async></script>

The following is the prompting output. The
comment was dynamically generated by YASnippet and the LM
generated the line after the comment, which contained a valid regex.

{{< highlight yaml "linenos=table, linenostart=1" >}}
import re

example = "This jug of water being $8.21 is outrageous!"
# regex to match dollar above.
dollar_re = re.compile(r'\$[0-9]*\.\d{1,3}')
{{< /highlight >}}


## Explanation of problem and solution {#explanation-of-problem-and-solution}


### The issue {#the-issue}

The problem with many prompts you will find
online is that they are static and a comment
in the prompt, for example `//`, `/*` or `#`
will be tailored for a specific language, so
the prompt is over-specified.


### The solution, using YASnippet {#the-solution-using-yasnippet}

`emacs` has many editing functions, which are
language agnostic and these can be used to
generate more powerful, dynamic prompting.

In this example, `emacs` detects the current
major mode (i.e. language) before the prompt
is run and then when the prompt template
expands, an interactive function `comment-
line` is run to put the correct comment syntax
into the prompt.


### Why it's important {#why-it-s-important}

Custom tailorded comments are important for
code generation from comments, however we may
want to generate code from a description where
no such comment yet exists.


## The dynamic prompt {#the-dynamic-prompt}

-   <http://github.com/semiosis/prompts/blob/master/prompts/generate-regex.prompt>
-   `end-yas: on` means that the YASnippet will
    expand the prompt just before it is evaluated.
    -   If `start-yas` was used, this would happen towards the start of prompt generation.
-   `` `(comment-line 1)` `` is an elisp function embedded in the prompt via YASnippet.

<!--listend-->

{{< highlight yaml "linenos=table, linenostart=1" >}}
title: gpt-j generate regex
include: Generic completion 50 tokens
prompt-version: 3
# lm-command: "openai-complete.sh"
# model: davinci
lm-command: "aix-complete.sh"
model: GPT-J-6B
# this flag instructs pen-aix to add a newline before the response
# The AIx API appears to remove all beginning whitespace, which may be a bug
flags:
- aix-begin-newline
prompt: |+
  <text><:pp>
  regex to match <thing to match> above`(comment-line 1)`.
vars:
- text
- thing to match
var-defaults:
- "(pen-preceding-text)"
end-yas: on
# The start will not be trimmed
completion: on
{{< /highlight >}}